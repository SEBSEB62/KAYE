import{n as b,p as P,q as V,t as D,m as G,j as e,R as $,r as c,L as K,d as T,e as F,S as h,K as U,c as v,u as X,w as M}from"./Icons-C56Ecv4l.js";import{G as B}from"./index-dXEpzMxB.js";var S={};const I=async(a,n,r,s,l)=>{if(!b)throw console.error("[LICENSE_SERVICE] Firebase is not initialized. Cannot store license key."),new Error("Le service de base de données n'est pas disponible.");if(!navigator.onLine)throw console.warn("[LICENSE_SERVICE] Offline. Cannot store license key."),new Error("Vous êtes hors ligne. Impossible de contacter la base de données pour stocker la clé.");try{console.log(`[LICENSE_SERVICE] Storing license key: Key=${a}, Plan=${n}, Duration=${r}d, Client=${l}`);const o=P(b,"licenses",a);await V(o,{status:"available",createdAt:D(),plan:n,duration:r,generatedFor:{userId:s,userEmail:l}})}catch(o){throw console.error("[LICENSE_SERVICE] Firebase error while storing key:",o),o?.code==="unavailable"?new Error("Connexion au serveur impossible. Vérifiez votre connexion Internet."):new Error("Une erreur inattendue est survenue lors de la sauvegarde de la clé.")}},p=async(a,n,r,s,l)=>{console.warn(`[LICENSE_SERVICE] Generating fallback key. Reason: ${l}`);const o=()=>Array.from(crypto.getRandomValues(new Uint8Array(2))).map(d=>d.toString(16).padStart(2,"0")).join("").toUpperCase(),m=`BUVPLUS-${o()}-${o()}-${o()}`;try{return await I(m,a,n,r,s),console.log(`[LICENSE_SERVICE] Fallback key generated and stored: ${m}`),m}catch(d){throw console.error("[LICENSE_SERVICE] Error storing fallback key:",d),new Error("Failed to save fallback key.")}},z=async(a,n,r,s)=>{if(console.log(`[LICENSE_SERVICE] Starting key generation for ${s} (Plan: ${a}, Duration: ${n}d)`),!S.VITE_GEMINI_API_KEY)return p(a,n,r,s,"VITE_GEMINI_API_KEY not configured.");try{console.log("[LICENSE_SERVICE] Attempting generation via Gemini API.");const d=(await new B({apiKey:S.VITE_GEMINI_API_KEY}).models.generateContent({model:"gemini-2.5-flash",contents:`Generate a unique, secure, and memorable license key for a software product named "Buvette+".
        The key must follow the format: BUVPLUS-XXXX-XXXX-XXXX where X is an alphanumeric character (A-Z, 0-9).
        The key must be completely random. Only return the key itself, with no extra text, explanation, or markdown.`,config:{thinkingConfig:{thinkingBudget:0}}})).text;if(console.log(`[LICENSE_SERVICE] Key received from Gemini: "${d}"`),!d)return p(a,n,r,s,"Empty response from Gemini.");const i=d.trim();return/^BUVPLUS-([A-Z0-9]{4})-([A-Z0-9]{4})-([A-Z0-9]{4})$/.test(i)?(await I(i,a,n,r,s),console.log(`[LICENSE_SERVICE] Valid Gemini key generated and stored: ${i}`),i):p(a,n,r,s,`Invalid key format from Gemini: "${i}"`)}catch(l){return console.error("Error generating license key with Gemini, using fallback:",l),p(a,n,r,s,`Gemini API error: ${l instanceof Error?l.message:String(l)}`)}};var O={};const Y="CHANGER_CE_MOT_DE_PASSE_SECRET_123!";async function q(){if(!b)throw new Error("Firebase non configuré. Impossible de charger les licences.");if(!navigator.onLine)throw new Error("Vous êtes hors ligne. Impossible de charger les licences.");try{const a=X(b,"licenses");return(await M(a)).docs.map(r=>{const s=r.data();return{id:r.id,status:s.status,plan:s.plan,duration:s.duration,generatedFor:s.generatedFor,createdAt:s.createdAt?.toDate()||new Date,activatedAt:s.activatedAt?.toDate()}}).sort((r,s)=>s.createdAt.getTime()-r.createdAt.getTime())}catch(a){throw console.error("Erreur lors de la récupération des licences:",a),a?.code==="unavailable"?new Error("Connexion au serveur impossible. Vérifiez votre connexion Internet."):new Error("Une erreur inattendue est survenue lors du chargement des licences.")}}const Z=({onSuccess:a})=>{const[n,r]=c.useState(""),[s,l]=c.useState(""),[o,m]=c.useState(!1),d=i=>{i.preventDefault(),n===Y?a():(l("Mot de passe incorrect."),r(""))};return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"bg-[#2a2a2a] p-8 rounded-2xl shadow-2xl border-2 border-amber-500/50 w-full max-w-sm",children:[e.jsx(K,{className:"w-16 h-16 text-amber-400 mx-auto"}),e.jsx("h1",{className:"text-3xl font-display text-amber-400 mt-4 text-center",children:"Accès Super Administrateur"}),e.jsxs("form",{onSubmit:d,className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:o?"text":"password",value:n,onChange:i=>r(i.target.value),className:"w-full p-3 border-2 bg-black/20 text-white border-white/10 rounded-xl shadow-sm focus:ring-amber-500 focus:border-amber-500 text-center transition",placeholder:"Mot de passe",autoFocus:!0}),e.jsx("button",{type:"button",onClick:()=>m(!o),className:"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white transition-colors",children:o?e.jsx(T,{className:"w-5 h-5"}):e.jsx(F,{className:"w-5 h-5"})})]}),s&&e.jsx("p",{className:"text-red-400 text-sm text-center",children:s}),e.jsx("button",{type:"submit",className:"w-full bg-amber-500 text-black font-bold py-3 px-6 rounded-full shadow-lg hover:bg-amber-600 font-display text-lg",children:"Connexion"})]})]})})},H=()=>{const[a,n]=c.useState(!1),[r,s]=c.useState(null),[l,o]=c.useState(null),[m,d]=c.useState(h.STANDARD),[i,A]=c.useState(30),[x,k]=c.useState(""),[g,_]=c.useState(""),[y,L]=c.useState([]),[N,j]=c.useState(!1),w=!!O.VITE_GEMINI_API_KEY,R=async()=>{if(!x||!g){o("L'email et l'ID du client sont requis.");return}n(!0),o(null),s(null);try{const t=await z(m,i,g,x);s(t),f()}catch(t){const E=t instanceof Error?t.message:"Une erreur inconnue est survenue.";o(`Impossible de générer la clé : ${E}`)}finally{n(!1)}},f=async()=>{j(!0),o(null);try{const t=await q();L(t)}catch(t){const E=t instanceof Error?t.message:"Impossible de charger la liste des licences.";o(E)}finally{j(!1)}};c.useEffect(()=>{f()},[]);const u="block w-full p-3 bg-[#1a1a1a] border-2 border-white/20 text-white rounded-xl shadow-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition";return e.jsxs("div",{className:"max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 space-y-8",children:[e.jsxs("div",{className:"text-center",children:[e.jsx(U,{className:"w-16 h-16 text-amber-400 mx-auto"}),e.jsx("h1",{className:"text-4xl font-display text-amber-400 mt-4",children:"Panneau Super Admin"}),e.jsx("p",{className:"text-slate-400 mt-2",children:"Générez et gérez les clés de licence pour vos clients."})]}),e.jsxs("section",{className:"bg-[#2a2a2a] p-6 rounded-2xl shadow-lg border border-white/10 space-y-4",children:[e.jsx("h2",{className:"text-2xl font-display text-slate-200",children:"Générer une Clé"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1",children:"Email du client"}),e.jsx("input",{type:"email",value:x,onChange:t=>k(t.target.value),placeholder:"client@email.com",className:u})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1",children:"ID du client (UID Firebase)"}),e.jsx("input",{type:"text",value:g,onChange:t=>_(t.target.value),placeholder:"Trouvé dans la console Firebase",className:u})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1",children:"Plan"}),e.jsxs("select",{value:m,onChange:t=>d(t.target.value),className:u,children:[e.jsx("option",{value:h.ESSENTIEL,children:"Essentiel"}),e.jsx("option",{value:h.STANDARD,children:"Standard"}),e.jsx("option",{value:h.PRO,children:"Pro"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1",children:"Durée (jours)"}),e.jsx("input",{type:"number",value:i,onChange:t=>A(parseInt(t.target.value,10)||0),className:u,min:"1"})]})]}),e.jsx("button",{onClick:R,disabled:a||!w,className:"w-full flex items-center justify-center bg-amber-500 text-black font-bold py-3 px-6 rounded-full shadow-lg hover:bg-amber-600 font-display text-lg disabled:opacity-50 disabled:cursor-not-allowed",children:a?e.jsx(v,{className:"w-6 h-6 animate-spin"}):"Générer la Clé"}),!w&&e.jsx("p",{className:"text-red-400 text-sm text-center",children:"La génération est désactivée (VITE_GEMINI_API_KEY manquante)."})]}),l&&e.jsx("p",{className:"text-red-400 p-4 bg-red-900/30 rounded-lg text-center",children:l}),r&&e.jsxs("div",{className:"p-4 bg-black/30 rounded-xl border-2 border-dashed border-amber-500 text-center",children:[e.jsxs("p",{className:"text-sm text-slate-300",children:["Clé générée pour ",x," :"]}),e.jsx("div",{className:"my-2 p-3 bg-[#1a1a1a] rounded-lg text-amber-300 font-mono text-lg break-all select-all",children:r})]}),e.jsxs("section",{className:"bg-[#2a2a2a] p-6 rounded-2xl shadow-lg border border-white/10 space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-display text-slate-200",children:"Licences Existantes"}),e.jsx("button",{onClick:f,disabled:N,className:"bg-slate-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm hover:bg-slate-700 disabled:opacity-50",children:N?e.jsx(v,{className:"w-5 h-5 animate-spin"}):"Rafraîchir"})]}),e.jsxs("div",{className:"overflow-x-auto max-h-96",children:[e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-black/30 text-xs text-slate-300 uppercase sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3",children:"Statut"}),e.jsx("th",{className:"px-4 py-3",children:"Clé"}),e.jsx("th",{className:"px-4 py-3",children:"Client (Email)"}),e.jsx("th",{className:"px-4 py-3",children:"ID Client"}),e.jsx("th",{className:"px-4 py-3",children:"Plan"}),e.jsx("th",{className:"px-4 py-3",children:"Créée le"}),e.jsx("th",{className:"px-4 py-3",children:"Activée le"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-700",children:y.map(t=>e.jsxs("tr",{className:"hover:bg-black/20",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`px-2 py-1 text-xs font-bold rounded-full ${t.status==="activated"?"bg-red-800 text-red-200":"bg-emerald-800 text-emerald-200"}`,children:t.status==="activated"?"Utilisée":"Dispo"})}),e.jsx("td",{className:"px-4 py-3 font-mono text-amber-300",children:t.id}),e.jsx("td",{className:"px-4 py-3",children:t.generatedFor.userEmail}),e.jsx("td",{className:"px-4 py-3 font-mono text-xs text-slate-400 select-all",children:t.generatedFor.userId}),e.jsxs("td",{className:"px-4 py-3",children:[t.plan," (",t.duration,"j)"]}),e.jsx("td",{className:"px-4 py-3",children:t.createdAt.toLocaleDateString("fr-FR")}),e.jsx("td",{className:"px-4 py-3",children:t.activatedAt?t.activatedAt.toLocaleString("fr-FR"):"—"})]},t.id))})]}),y.length===0&&e.jsx("p",{className:"text-center p-4 text-slate-500",children:"Aucune licence trouvée."})]})]})]})},J=()=>{const[a,n]=c.useState(!1);return a?e.jsx(H,{}):e.jsx(Z,{onSuccess:()=>n(!0)})},C=document.getElementById("root");if(!C)throw new Error("Could not find root element to mount to");const Q=G.createRoot(C);Q.render(e.jsx($.StrictMode,{children:e.jsx(J,{})}));
