import{r as o,j as e,G as V,R as Q,z as Y,I as G,f as J}from"./Icons-C56Ecv4l.js";import{u as q,P as R,c as _,M as $}from"./main-sP1ObtPy.js";import{N as W}from"./NumericKeypad-CSJS3737.js";import{f as O}from"./formatting-B5pXF3od.js";import{C as X}from"./ConfirmModal-BKYg9vdT.js";import{u as Z}from"./useDebounce-7V9QMTWI.js";import{E as ee,a as te}from"./jspdf.plugin.autotable-CeTCctcS.js";const se=o.memo(({isOpen:a,onClose:r,onCreate:b})=>{const[h,i]=o.useState(""),n=o.useRef(null);o.useEffect(()=>{a&&(i(""),setTimeout(()=>{n.current?.focus()},100))},[a]);const m=()=>{h.trim()&&(b(h.trim()),i(""))},p=s=>{s.key==="Enter"&&(s.preventDefault(),m())};return e.jsx($,{isOpen:a,onClose:r,title:"Nouvelle Cat√©gorie",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-slate-400 text-sm",children:"Ajoutez une nouvelle cat√©gorie pour classer vos produits."}),e.jsx("input",{ref:n,type:"text",value:h,onChange:s=>i(s.target.value),onKeyDown:p,placeholder:"Ex: Bijoux, Soins...",className:"mt-1 block w-full p-2 bg-[#1a1a1a] border border-white/20 text-white rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500"}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:r,className:"px-4 py-2 text-slate-300 hover:bg-white/10 rounded-lg",children:"Annuler"}),e.jsx("button",{type:"button",onClick:m,disabled:!h.trim(),className:"px-4 py-2 bg-amber-500 text-black font-bold rounded-lg hover:bg-amber-400 disabled:opacity-50",children:"Cr√©er"})]})]})})}),ae=({product:a,onDone:r})=>{const{addProduct:b,updateProduct:h,settings:i,setSettings:n,showToast:m}=q(),p=()=>({name:"",price:0,purchasePrice:0,tokenPrice:0,stock:0,category:i.categories[0]||"Divers",image:"‚ùì",packageUnit:"",servingsPerPackage:0,laborTimeMinutes:0,...a}),[s,c]=o.useState(p()),[j,v]=o.useState(s.image||null),[A,N]=o.useState(!1),D=o.useRef(null);o.useEffect(()=>{const l=p();c(l),v(l.image||"‚ùì")},[a]);const S=l=>{const{name:d,value:C}=l.target;c(M=>({...M,[d]:C}))},w=l=>{const{name:d,value:C}=l.target;c(M=>({...M,[d]:C===""?"":parseFloat(C)}))},F=async l=>{if(l.target.files&&l.target.files[0])try{const d=await _(l.target.files[0]);c(C=>({...C,image:d})),v(d)}catch(d){m(d instanceof Error?d.message:"Erreur lors du traitement de l'image.","error")}},P=l=>{if(i.categories.includes(l)){m("Cette cat√©gorie existe d√©j√†.","error");return}n(d=>({...d,categories:[...d.categories,l]})),c(d=>({...d,category:l})),N(!1),m(`Cat√©gorie "${l}" ajout√©e !`,"success")},E=l=>{if(l.preventDefault(),!s.name||s.price==null||s.stock==null){m("Les champs Nom, Prix de vente et Stock sont obligatoires.","error");return}const d={name:s.name,price:Number(s.price||0),purchasePrice:Number(s.purchasePrice||0),tokenPrice:Number(s.tokenPrice||0),stock:Number(s.stock||0),image:s.image||"‚ùì",category:s.category||i.categories[0]||"Divers",packageUnit:s.packageUnit,servingsPerPackage:Number(s.servingsPerPackage||0),laborTimeMinutes:Number(s.laborTimeMinutes||0)};a?.id?h({...d,id:a.id}):b(d),r()},u="mt-1 block w-full p-2 bg-[#1a1a1a] border border-white/20 text-white rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500";return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-24 h-24 rounded-lg overflow-hidden bg-black/20 flex items-center justify-center flex-shrink-0 border border-white/10",children:j&&e.jsx(R,{image:j,alt:"Aper√ßu",className:"w-full h-full object-contain text-4xl"})}),e.jsxs("div",{className:"flex-grow space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:"Image ou Emoji"}),e.jsx("input",{type:"text",name:"image",value:typeof s.image=="string"?s.image:"",onChange:S,placeholder:"collez un emoji ici",className:u}),e.jsx("button",{type:"button",onClick:()=>D.current?.click(),className:`${u} text-center cursor-pointer w-full`,children:"Charger une image"}),e.jsx("input",{type:"file",ref:D,onChange:F,accept:"image/*",className:"hidden"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:"Nom du produit"}),e.jsx("input",{type:"text",name:"name",value:s.name||"",onChange:S,className:u,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:"Cat√©gorie"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("select",{name:"category",value:s.category,onChange:S,className:u,children:i.categories.map(l=>e.jsx("option",{value:l,children:l},l))}),e.jsx("button",{type:"button",onClick:()=>N(!0),className:"mt-1 p-2 bg-slate-700 hover:bg-slate-600 rounded-md border border-white/20 text-white",title:"Cr√©er une cat√©gorie",children:e.jsx(V,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:"Prix de Vente (‚Ç¨)"}),e.jsx("input",{type:"number",name:"price",value:s.price??"",onChange:w,className:u,required:!0,step:"0.01",min:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:"Prix d'Achat (‚Ç¨)"}),e.jsx("input",{type:"number",name:"purchasePrice",value:s.purchasePrice??"",onChange:w,className:u,step:"0.01",min:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:"Stock"}),e.jsx("input",{type:"number",name:"stock",value:s.stock??"",onChange:w,className:u,required:!0,step:"1",min:"0"})]}),i.tokenMode&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:"Prix en Jetons"}),e.jsx("input",{type:"number",name:"tokenPrice",value:s.tokenPrice??"",onChange:w,className:u,step:"1",min:"0"})]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:"Temps de travail estim√© (minutes)"}),e.jsx("input",{type:"number",name:"laborTimeMinutes",value:s.laborTimeMinutes??"",onChange:w,className:u,step:"1",min:"0"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Saisissez le temps moyen pour fabriquer/pr√©parer une unit√© (ex: 30)."})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:"Unit√© (ex: pack de 6)"}),e.jsx("input",{type:"text",name:"packageUnit",value:s.packageUnit||"",onChange:S,className:u})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:"Portions/paquet"}),e.jsx("input",{type:"number",name:"servingsPerPackage",value:s.servingsPerPackage??"",onChange:w,className:u,step:"1",min:"0"})]})]}),e.jsxs("div",{className:"pt-4 flex justify-end gap-4",children:[e.jsx("button",{type:"button",onClick:r,className:"bg-slate-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-slate-700 transition",children:"Annuler"}),e.jsx("button",{type:"submit",className:"bg-amber-500 text-black font-bold py-2 px-4 rounded-full shadow-lg hover:bg-amber-600 transition",children:"Enregistrer"})]})]}),e.jsx(se,{isOpen:A,onClose:()=>N(!1),onCreate:P})]})},re=o.memo(ae),oe=({isOpen:a,onClose:r,history:b,productName:h})=>{const i=n=>{switch(n){case"sale":return{icon:"üõí",color:"text-red-400"};case"add":return{icon:"üì¶",color:"text-emerald-400"};case"edit":return{icon:"‚úèÔ∏è",color:"text-sky-400"};case"refund":return{icon:"‚Ü©Ô∏è",color:"text-amber-400"};case"initial":return{icon:"‚ú®",color:"text-purple-400"};default:return{icon:"üìù",color:"text-slate-400"}}};return e.jsx($,{isOpen:a,onClose:r,title:`Historique de ${h}`,children:e.jsx("div",{className:"space-y-3 max-h-[60vh] overflow-y-auto pr-2",children:b.length>0?b.map(n=>{const{icon:m,color:p}=i(n.type),s=n.quantityChange>0?"+":"";return e.jsxs("div",{className:"bg-black/20 p-3 rounded-lg flex items-center space-x-3",children:[e.jsx("span",{className:"text-2xl",children:m}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("p",{className:"font-semibold text-slate-200 capitalize",children:n.type}),e.jsx("p",{className:"text-xs text-slate-400",children:new Date(n.date).toLocaleString("fr-FR")}),n.note&&e.jsxs("p",{className:"text-xs text-slate-300 italic",children:['"',n.note,'"']})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:`font-bold text-lg ${p}`,children:[s,n.quantityChange]}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Stock: ",n.newStock]})]})]},n.id)}):e.jsx("p",{className:"text-center text-slate-400 p-4",children:"Aucun historique pour ce produit."})})})},le=Q.memo(oe),ne=o.memo(({product:a,onClose:r})=>{const{updateProduct:b,addStockHistoryEntry:h}=q(),[i,n]=o.useState(""),[m,p]=o.useState(""),s=()=>{if(!a||!i)return;const c=parseInt(i,10);if(isNaN(c)||c<=0)return;const j=a.stock+c;b({...a,stock:j}),h({productId:a.id,productName:a.name,type:"add",quantityChange:c,newStock:j,note:m||"Ajout manuel"}),r()};return a?e.jsx($,{isOpen:!!a,onClose:r,title:"Ajouter du Stock",children:e.jsxs("div",{className:"space-y-4 text-center",children:[e.jsx("p",{className:"text-xl text-slate-200 font-display",children:a.name}),e.jsxs("p",{className:"text-sm text-slate-400",children:["Stock actuel : ",a.stock]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1",children:"Note (optionnel)"}),e.jsx("input",{type:"text",value:m,onChange:c=>p(c.target.value),placeholder:"ex: Nouvelle livraison",className:"block w-full p-2 border-white/20 rounded-md shadow-sm bg-[#1a1a1a] text-white"})]}),e.jsx("input",{type:"text",readOnly:!0,value:i,placeholder:"Quantit√© √† ajouter",className:"block w-full text-center text-4xl p-2 border-white/20 rounded-md shadow-sm bg-[#1a1a1a] text-white font-sans"}),e.jsx(W,{onKeyPress:c=>{c!=="."&&n(j=>j+c)},onDelete:()=>n(c=>c.slice(0,-1)),onDone:s})]})}):null}),ie=({products:a})=>e.jsxs("div",{className:"bg-amber-900/50 border-2 border-amber-500/50 p-4 rounded-2xl animate-in fade-in-0",children:[e.jsxs("h2",{className:"text-lg font-display text-amber-300 flex items-center gap-2 mb-3",children:[e.jsx(J,{className:"w-6 h-6"}),"Alerte Stock Bas"]}),e.jsx("div",{className:"flex space-x-4 overflow-x-auto pb-2 -mx-4 px-4 no-scrollbar",children:a.map(r=>e.jsxs("div",{className:"bg-[#2a2a2a] p-3 rounded-xl shadow-sm w-36 flex-shrink-0 text-center border border-amber-500/50",children:[e.jsx("div",{className:"w-16 h-16 rounded-lg overflow-hidden bg-black/20 flex items-center justify-center mx-auto border border-white/10",children:e.jsx(R,{image:r.image,alt:r.name,className:"w-full h-full object-contain text-3xl"})}),e.jsx("p",{className:"font-bold text-slate-200 truncate mt-2 text-sm",children:r.name}),e.jsxs("p",{className:"text-amber-400 font-bold font-sans text-lg",children:[r.stock," restant",r.stock>1?"s":""]})]},r.id))})]}),ce=()=>{const{products:a,settings:r,stockHistory:b,deleteProduct:h,showToast:i}=q(),[n,m]=o.useState(!1),[p,s]=o.useState(null),[c,j]=o.useState(null),[v,A]=o.useState(null),[N,D]=o.useState(null),[S,w]=o.useState(""),F=Z(S,300),[P,E]=o.useState("all"),[u,l]=o.useState("name"),d=t=>{s(t),m(!0)},C=()=>{s({}),m(!0)},M=()=>{s(null),m(!1)},z=o.useMemo(()=>v?b.filter(t=>t.productId===v.id):[],[v,b]),B=o.useMemo(()=>a.filter(t=>t.stock<=r.lowStockThreshold&&t.stock>0).sort((t,x)=>t.stock-x.stock),[a,r.lowStockThreshold]),H=o.useMemo(()=>a.filter(x=>{const g=x.name.toLowerCase().includes(F.toLowerCase());let y=!0;return P==="low"?y=x.stock<=r.lowStockThreshold&&x.stock>0:P!=="all"&&(y=x.category===P),g&&y}).sort((x,g)=>u==="name"?x.name.localeCompare(g.name):x.stock-g.stock),[a,F,P,u,r.lowStockThreshold]),L=o.useCallback(()=>{N&&(h(N.id),D(null))},[N,h]),U=o.useCallback(()=>{try{const t=new ee,x=new Date().toLocaleDateString("fr-FR");t.setFont("helvetica","bold"),t.setFontSize(20),t.text(r.businessName||"Buvette+",14,22),t.setFontSize(16),t.text(`√âtat des Stocks - ${x}`,14,30);const g=a.reduce((f,T)=>{const k=T.category||"Divers";return f[k]||(f[k]=[]),f[k].push(T),f},{});let y=40;for(const f of Object.keys(g))if(g[f]){const T=g[f].map(k=>[k.name,k.stock,"",""]);te(t,{head:[[{content:f,styles:{fillColor:[41,128,185],textColor:255}}]],body:[["Produit","Stock Actuel","Quantit√© Compt√©e","Notes"],...T],startY:y,didParseCell:k=>{k.row.index===0&&k.section==="body"&&(k.cell.styles.fontStyle="bold")},theme:"grid"}),y=t.lastAutoTable.finalY+15}t.save(`inventaire-buvette-plus-${new Date().toISOString().slice(0,10)}.pdf`),i("PDF d'inventaire g√©n√©r√© avec succ√®s !")}catch(t){console.error(t),i("Erreur lors de la g√©n√©ration du PDF.","error")}},[a,r.businessName,i]),K=["all","low",...r.categories],I=B.length;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-4xl font-display text-center text-amber-400",children:"Gestion du Stock"}),I>0&&e.jsx(ie,{products:B}),e.jsxs("div",{className:"sticky top-0 z-10 bg-[#111] py-2 space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("label",{htmlFor:"stock-search",className:"sr-only",children:"Rechercher un produit"}),e.jsx("input",{id:"stock-search",type:"search",placeholder:"Rechercher un produit...",value:S,onChange:t=>w(t.target.value),className:"w-full pl-12 pr-4 py-3 bg-black/20 text-white border-2 border-white/20 focus:border-amber-500 rounded-xl shadow-sm transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-amber-500/50 placeholder-slate-400"}),e.jsx("div",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-slate-400",children:e.jsx(Y,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"flex space-x-3 overflow-x-auto pb-2 -mx-4 px-4 no-scrollbar",children:K.map(t=>e.jsxs("button",{onClick:()=>E(t),className:`relative px-4 py-2 text-sm font-bold rounded-full transition-all duration-200 whitespace-nowrap shadow-md border-2 ${P===t?"bg-amber-500 text-black border-amber-500 scale-105":"bg-[#2a2a2a] text-slate-300 hover:bg-[#3a3a3a] border-slate-700 hover:border-slate-600"}`,children:[t==="all"?"Tous":t==="low"?"Stock Bas":t,t==="low"&&I>0&&e.jsx("span",{className:"absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-red-600 rounded-full",children:I})]},t))}),e.jsxs("div",{className:"flex justify-between items-center gap-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-sm text-slate-400",children:"Trier par:"}),e.jsx("button",{onClick:()=>l("name"),className:`px-3 py-1 text-xs font-bold rounded-full ${u==="name"?"bg-amber-800/80 text-amber-200":"bg-white/10 text-slate-300"}`,children:"Nom"}),e.jsx("button",{onClick:()=>l("stock"),className:`px-3 py-1 text-xs font-bold rounded-full ${u==="stock"?"bg-amber-800/80 text-amber-200":"bg-white/10 text-slate-300"}`,children:"Stock"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:U,className:"bg-slate-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-slate-700 transition-transform font-display text-sm flex items-center gap-2",children:[e.jsx(G,{className:"w-4 h-4"})," PDF"]}),e.jsx("button",{onClick:C,className:"bg-amber-500 text-black font-bold py-2 px-4 rounded-full shadow-lg hover:bg-amber-600 transition-transform font-display text-sm",children:"+ Ajouter"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[H.map(t=>{const x=t.stock<=r.lowStockThreshold&&t.stock>0,g=t.stock===0,y=t.purchasePrice||0,f=(t.laborTimeMinutes||0)/60*(r.hourlyRate||0),T=y+f;return e.jsxs("div",{className:`bg-[#2a2a2a] p-3 rounded-xl shadow-sm border-l-4 ${g?"border-red-600":x?"border-amber-500":"border-slate-700"}`,children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-lg overflow-hidden bg-black/20 flex items-center justify-center flex-shrink-0 border border-white/10",children:e.jsx(R,{image:t.image,alt:t.name,className:"w-full h-full object-contain text-3xl"})}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("p",{className:"font-bold text-slate-200",children:t.name}),e.jsxs("p",{className:`text-xl font-sans font-bold ${g?"text-red-500":x?"text-amber-400":"text-slate-300"}`,children:["Stock: ",t.stock]}),e.jsxs("div",{className:"mt-2 text-sm",children:[e.jsxs("span",{className:`font-semibold ${t.price<T?"text-red-400":"text-slate-300"}`,children:["Prix: ",O(t.price)]}),e.jsxs("div",{className:"text-slate-500 dark:text-slate-400 mt-1",children:["Co√ªt Mat√©riel: ",O(y)," | Co√ªt Main d'≈ìuvre: ",O(f)]}),t.price<T&&e.jsx("div",{className:"mt-1 text-sm text-red-500 font-bold",children:"Vente √† perte !"})]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx("button",{onClick:()=>j(t),"aria-label":`Ajouter du stock pour ${t.name}`,className:"px-3 py-1 text-xs font-bold bg-white/10 rounded-full hover:bg-white/20 transition-colors",children:"Ajouter"}),e.jsx("button",{onClick:()=>d(t),"aria-label":`Modifier ${t.name}`,className:"px-3 py-1 text-xs font-bold bg-white/10 rounded-full hover:bg-white/20 transition-colors",children:"Modifier"})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-4 mt-2",children:[e.jsx("button",{onClick:()=>A(t),"aria-label":`Voir l'historique de ${t.name}`,className:"text-xs text-slate-400 hover:text-amber-400 transition-colors",children:"Historique"}),e.jsx("button",{onClick:()=>D(t),"aria-label":`Supprimer ${t.name}`,className:"text-xs text-red-300 hover:text-red-200 transition-colors",children:"Supprimer"})]})]},t.id)}),H.length===0&&e.jsx("div",{className:"text-center text-slate-500 p-8 bg-black/20 rounded-lg",children:e.jsx("p",{children:"Aucun produit ne correspond √† vos filtres."})})]}),e.jsx($,{isOpen:n,onClose:M,title:p?.id?"Modifier un Produit":"Ajouter un Produit",children:e.jsx(re,{product:p??void 0,onDone:M})}),e.jsx(ne,{product:c,onClose:()=>j(null)}),v&&e.jsx(le,{isOpen:!!v,onClose:()=>A(null),history:z,productName:v.name}),N&&e.jsx(X,{isOpen:!!N,onClose:()=>D(null),onConfirm:L,title:"Supprimer le Produit",message:e.jsxs(e.Fragment,{children:["√ätes-vous s√ªr de vouloir supprimer ",e.jsx("strong",{children:N.name})," ? Cette action est irr√©versible."]}),confirmText:"Supprimer"})]})},ge=o.memo(ce);export{ge as default};
